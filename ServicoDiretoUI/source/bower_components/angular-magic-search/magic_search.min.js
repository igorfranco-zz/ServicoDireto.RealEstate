try{angular.module("MagicSearch")}catch(exception){angular.module("MagicSearch",[])}angular.module("MagicSearch").directive("magicSearch",function(){return{restrict:"E",scope:{facets_param:"@facets",filter_keys:"=filterKeys",strings:"=strings"},templateUrl:function(scope,elem){return elem.template},controller:function($scope,$element,$timeout){var searchInput=$element.find(".search-input");$scope.promptString=$scope.strings.prompt,$scope.currentSearch=[],$scope.initSearch=function(){if("string"==typeof $scope.facets_param){var tmp=$scope.facets_param.replace(/__apos__/g,"'").replace(/__dquote__/g,'\\"').replace(/__bslash__/g,"\\");$scope.facetsObj=JSON.parse(tmp)}else $scope.facetsObj=$scope.facets_param;$scope.facetsSave=$scope.copyFacets($scope.facetsObj),$scope.initFacets()},$scope.initFacets=function(){var initialFacets=window.location.search;0===initialFacets.indexOf("?")&&(initialFacets=initialFacets.slice(1)),initialFacets=initialFacets.split("&"),(initialFacets.length>1||initialFacets[0].length>0)&&$timeout(function(){$scope.strings.prompt=""}),angular.forEach(initialFacets,function(facet){var facetParts=facet.split("=");angular.forEach($scope.facetsObj,function(value){value.name==facetParts[0]&&(void 0===value.options?$scope.currentSearch.push({name:facet,label:[value.label,facetParts[1]]}):angular.forEach(value.options,function(option){option.key==facetParts[1]&&($scope.currentSearch.push({name:facet,label:[value.label,option.label]}),value.singleton===!0?$scope.deleteFacetEntirely(facetParts):$scope.deleteFacetSelection(facetParts))}))})}),void 0!==$scope.textSearch&&$scope.currentSearch.push({name:"text="+$scope.textSearch,label:[$scope.strings.text,$scope.textSearch]}),$scope.filteredObj=$scope.facetsObj},$scope.addFacets=function(facets){for(var facet in facets)$scope.facetsObj.append(facet)},$scope.copyFacets=function(facets){for(var ret=[],i=0;i<facets.length;i++){var facet=Object.create(facets[i]);if(void 0!==facets[i].options){facet.options=[];for(var j=0;j<facets[i].options.length;j++)facet.options.push(Object.create(facets[i].options[j]))}ret.push(facet)}return ret},$scope.deleteFacetSelection=function(facetParts){angular.forEach($scope.facetsObj.slice(),function(facet,idx){if(facet.name==facetParts[0]){if(void 0===facet.options)return;for(var i=0;i<facet.options.length;i++){var option=facet.options[i];option.key==facetParts[1]&&$scope.facetsObj[idx].options.splice($scope.facetsObj[idx].options.indexOf(option),1)}0===facet.options.length&&$scope.facetsObj.splice($scope.facetsObj.indexOf(facet),1)}})},$scope.deleteFacetEntirely=function(facetParts){angular.forEach($scope.facetsObj.slice(),function(facet){facet.name==facetParts[0]&&$scope.facetsObj.splice($scope.facetsObj.indexOf(facet),1)})},searchInput.on("keydown",function($event){var key=$event.keyCode||$event.charCode;9==key&&$event.preventDefault()}),searchInput.on("keyup",function($event){if($event.metaKey!==!0){var searchVal=searchInput.val(),key=$event.keyCode||$event.charCode;if(9==key){if(void 0===$scope.facetSelected){if(1!=$scope.filteredObj.length)return;$scope.facetClicked(0,"",$scope.filteredObj[0].name)}else{if(void 0===$scope.filteredOptions||1!=$scope.filteredOptions.length)return;$scope.optionClicked(0,"",$scope.filteredOptions[0].key),$scope.resetState()}return void $timeout(function(){searchInput.val("")})}if(27==key){$timeout(function(){$scope.hideMenu(),searchInput.val("")}),$scope.resetState();var textFilter=$scope.textSearch;return void 0===textFilter&&(textFilter=""),void $scope.$emit("textSearch",textFilter,$scope.filter_keys)}if(13==key){if($scope.facetSelected&&void 0===$scope.facetSelected.options){var curr=$scope.facetSelected;curr.name=curr.name+"="+searchVal,curr.label[1]=searchVal,$scope.currentSearch.push(curr),$scope.resetState(),$scope.emitQuery(),$scope.showMenu()}else{for(i=0;i<$scope.currentSearch.length;i++)0===$scope.currentSearch[i].name.indexOf("text")&&$scope.currentSearch.splice(i,1);$scope.currentSearch.push({name:"text="+searchVal,label:[$scope.strings.text,searchVal]}),$scope.$apply(),$scope.hideMenu(),searchInput.val(""),$scope.$emit("textSearch",searchVal,$scope.filter_keys),$scope.textSearch=searchVal}$scope.filteredObj=$scope.facetsObj}else""===searchVal?($scope.filteredObj=$scope.facetsObj,$scope.$apply(),$scope.$emit("textSearch","",$scope.filter_keys),$scope.facetSelected&&void 0===$scope.facetSelected.options&&$scope.resetState()):$scope.filterFacets(searchVal)}}),searchInput.on("keypress",function($event){var searchVal=searchInput.val(),key=$event.which||$event.keyCode||$event.charCode;return 8!=key&&46!=key&&13!=key&&9!=key&&27!=key&&(searchVal+=String.fromCharCode(key).toLowerCase())," "==searchVal?($scope.showMenu(),void $timeout(function(){searchInput.val("")})):""===searchVal?($scope.filteredObj=$scope.facetsObj,$scope.$apply(),$scope.$emit("textSearch","",$scope.filter_keys),void($scope.facetSelected&&void 0===$scope.facetSelected.options&&$scope.resetState())):void(8!=key&&46!=key&&$scope.filterFacets(searchVal))}),$scope.filterFacets=function(searchVal){var i,idx,label,filtered=[];if(void 0===$scope.facetSelected){for($scope.filteredObj=$scope.facetsObj,i=0;i<$scope.filteredObj.length;i++){var facet=$scope.filteredObj[i];idx=facet.label.toLowerCase().indexOf(searchVal),idx>-1&&(label=[facet.label.substring(0,idx),facet.label.substring(idx,idx+searchVal.length),facet.label.substring(idx+searchVal.length)],filtered.push({name:facet.name,label:label,options:facet.options}))}filtered.length>0?($scope.showMenu(),$timeout(function(){$scope.filteredObj=filtered},.1)):($scope.$emit("textSearch",searchVal,$scope.filter_keys),$scope.hideMenu())}else{if($scope.filteredOptions=$scope.facetOptions,void 0===$scope.facetOptions)return;for(i=0;i<$scope.filteredOptions.length;i++){var option=$scope.filteredOptions[i];idx=option.label.toLowerCase().indexOf(searchVal),idx>-1&&(label=[option.label.substring(0,idx),option.label.substring(idx,idx+searchVal.length),option.label.substring(idx+searchVal.length)],filtered.push({key:option.key,label:label}))}filtered.length>0&&($scope.showMenu(),$timeout(function(){$scope.filteredOptions=filtered},.1))}},$element.find(".search-main-area").on("click",function($event){var target=$($event.target);target.is(".search-main-area")&&(searchInput.trigger("focus"),$scope.showMenu())}),$scope.facetClicked=function($index){$scope.hideMenu();var facet=$scope.filteredObj[$index],label=facet.label;Array.isArray(label)&&(label=label.join("")),$scope.facetSelected={name:facet.name,label:[label,""]},void 0!==facet.options&&($scope.filteredOptions=$scope.facetOptions=facet.options,$scope.showMenu()),$timeout(function(){searchInput.val("")}),$scope.strings.prompt="",$timeout(function(){searchInput.focus()})},$scope.optionClicked=function($index,$event,name){$scope.hideMenu();var curr=$scope.facetSelected;curr.name=curr.name+"="+name,curr.label[1]=$scope.filteredOptions[$index].label,Array.isArray(curr.label[1])&&(curr.label[1]=curr.label[1].join("")),$scope.currentSearch.push(curr),$scope.resetState(),$scope.emitQuery(),$scope.showMenu()},$scope.emitQuery=function(removed){for(var query="",i=0;i<$scope.currentSearch.length;i++)0!==$scope.currentSearch[i].name.indexOf("text")&&(query.length>0&&(query+="&"),query+=$scope.currentSearch[i].name);if(void 0!==removed&&0===removed.indexOf("text"))$scope.$emit("textSearch","",$scope.filter_keys),$scope.textSearch=void 0;else if($scope.$emit("searchUpdated",query),$scope.currentSearch.length>0){var newFacet=$scope.currentSearch[$scope.currentSearch.length-1].name,facetParts=newFacet.split("=");angular.forEach($scope.facetsSave,function(facet){facet.name==facetParts[0]&&(facet.singleton===!0?$scope.deleteFacetEntirely(facetParts):$scope.deleteFacetSelection(facetParts))})}},$scope.removeFacet=function($index){var removed=$scope.currentSearch[$index].name;$scope.currentSearch.splice($index,1),void 0===$scope.facetSelected?$scope.emitQuery(removed):($scope.resetState(),searchInput.val("")),0===$scope.currentSearch.length&&($scope.strings.prompt=$scope.promptString),$scope.facetsObj=$scope.copyFacets($scope.facetsSave),$scope.currentSearch=[],$scope.initFacets()},$scope.clearSearch=function(){$scope.currentSearch.length>0&&($scope.currentSearch=[],$scope.facetsObj=$scope.copyFacets($scope.facetsSave),$scope.resetState(),$scope.$emit("searchUpdated",""),$scope.$emit("textSearch","",$scope.filter_keys))},$scope.isMatchLabel=function(label){return Array.isArray(label)},$scope.resetState=function(){searchInput.val(""),$scope.filteredObj=$scope.facetsObj,$scope.facetSelected=void 0,$scope.facetOptions=void 0,$scope.filteredOptions=void 0,0===$scope.currentSearch.length&&($scope.strings.prompt=$scope.promptString)},$scope.showMenu=function(){$timeout(function(){$("#facet-drop").hasClass("open")===!1&&$scope.filteredObj.length>0&&$(".search-input").trigger("click")})},$scope.hideMenu=function(){$(document).foundation("dropdown","closeall")},$scope.initSearch()}}});